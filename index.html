<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°±æ±ºå®šæ˜¯ä½ äº†ï¼æ”¶æœè‡ºç£æ¶ˆå¤±çš„ç³–å» èˆ‡éµé“</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        /* --- æ¨£å¼å®šç¾©ï¼šç´…çƒä¸»é¡Œ --- */
        :root { --dex-red: #dd0b2d; --screen-bg: #98cb98; --btn-blue: #22edfc; --poke-yellow: #ffcb05; --poke-blue: #2a75bb; }
        body {
            margin: 0; padding: 0; height: 100vh;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: #333;
            background-image: url('/123/pokemon_bg.png');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }

        /* é–‹å ´ç•«é¢ */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, var(--dex-red) 50%, #f0f0f0 50%);
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.8s ease-in-out;
        }
        #start-screen::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 40px; background: #000; transform: translateY(-50%); z-index: -1; }
        .poke-ball-btn { width: 100px; height: 100px; background: #fff; border: 10px solid #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1; }
        #start-screen.hidden { transform: translateY(-100%); }
        .title-box { background: rgba(255,255,255,0.95); border: 6px solid #000; padding: 30px; text-align: center; margin-bottom: 120px; box-shadow: 10px 10px 0 rgba(0,0,0,0.5); }
        .start-btn { background: #ffde00; border: 4px solid var(--poke-blue); padding: 15px 30px; font-family: 'Press Start 2P', cursive; font-size: 18px; cursor: pointer; box-shadow: 6px 6px 0 #000; animation: blink 1s infinite; margin-top: 100px; }
        .start-btn:hover { transform: scale(1.1); background: #fff; }
        @keyframes blink { 50% { opacity: 0; } }

        /* åœ–é‘‘æ©Ÿèº« */
        #pokedex {
            position: relative; z-index: 10;
            width: 90vw; max-width: 900px; height: 90vh; max-height: 750px;
            background-color: var(--dex-red); 
            border-radius: 20px 20px 20px 60px;
            padding: 20px; display: flex; flex-direction: column;
            border: 6px solid #000; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .header-deco { position: relative; height: 60px; width: 100%; margin-bottom: 10px; }
        .camera-lens { width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, #fff, var(--btn-blue)); border: 5px solid #fff; border-radius: 50%; position: absolute; top: 0; left: 0; box-shadow: 0 0 15px var(--btn-blue); animation: lightPulse 3s infinite; }
        .small-lights { position: absolute; top: 5px; left: 70px; display: flex; gap: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #000; }
        .red { background: #f00; } .yellow { background: #ffde00; } .green { background: #0f0; }
        @keyframes lightPulse { 0% { opacity: 0.6; } 50% { opacity: 1; box-shadow: 0 0 25px var(--btn-blue); } 100% { opacity: 0.6; } }

        #screen-container { flex-grow: 1; background: #b0b0b0; border-radius: 10px 10px 40px 10px; padding: 15px 15px 40px 15px; border: 4px solid #000; display: flex; flex-direction: column; position: relative; }
        #map-border { border: 4px solid #5a5a5a; border-radius: 5px; height: 100%; background: #000; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.5); overflow: hidden; position: relative; }
        #map { width: 100%; height: 100%; background: #a8dcb0; image-rendering: pixelated; }

        #controls-area { height: 60px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px 20px; background: #222; border-radius: 10px; border: 3px solid #000; }
        #search-input { width: 100%; background: #98cb98; border: none; padding: 12px; font-family: 'Press Start 2P', cursive; font-size: 12px; color: #000; box-shadow: inset 3px 3px 0 rgba(0,0,0,0.2); }
        #search-input:focus { outline: 2px solid var(--dex-red); }
        .btn-group { display: flex; gap: 5px; }
        button { background: #ffde00; border: 3px solid #000; padding: 12px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 10px; box-shadow: 4px 4px 0 #000; }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }

        /* çš®å¡ä¸˜æ§åˆ¶å™¨ */
        .custom-layer-control {
            position: absolute; top: 20px; right: 10px; z-index: 1000;
            background: #fff; border: 4px solid var(--poke-blue); border-radius: 15px;
            padding: 0; font-size: 10px; color: #000; box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            max-height: 85%; overflow: visible; width: 260px; animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .custom-layer-control::before {
            content: ''; position: absolute; top: -40px; right: 5px; width: 50px; height: 50px;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/25.gif');
            background-repeat: no-repeat; background-size: contain; z-index: 2;
        }

        .control-title-bar { background: var(--poke-yellow); border-bottom: 4px solid var(--poke-blue); padding: 10px; text-align: center; font-weight: bold; color: var(--poke-blue); border-radius: 10px 10px 0 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .control-content { padding: 10px; background: #fff; border-radius: 0 0 10px 10px; max-height: 300px; overflow-y: auto; }
        .layer-item { margin-bottom: 12px; border: 2px solid #eee; border-radius: 8px; padding: 8px; background: #f9f9f9; transition: 0.2s; }
        .layer-item:hover { border-color: var(--poke-blue); background: #eef7ff; }
        .layer-label { display: flex; align-items: center; gap: 8px; cursor: pointer; line-height: 1.4; font-size: 9px; }
        
        /* Checkbox - ç´…çƒ */
        input[type="checkbox"] { appearance: none; width: 16px; height: 16px; border: 2px solid #333; border-radius: 50%; background: #fff; cursor: pointer; position: relative; }
        input[type="checkbox"]:checked { background: linear-gradient(to bottom, #f00 50%, #fff 50%); } 
        input[type="checkbox"]:checked::after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #fff; border: 1px solid #333; border-radius: 50%; transform: translate(-50%, -50%); }
        .opacity-slider { width: 100%; height: 6px; -webkit-appearance: none; background: #ddd; outline: none; border-radius: 3px; }
        .opacity-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--poke-blue); border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 2px #000; cursor: pointer; }

        .leaflet-popup-content-wrapper { border-radius: 0; border: 4px solid #000; box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
        .leaflet-popup-content { margin: 10px; font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 1.5; }
        .leaflet-control-zoom { display: none; }
        .pokemon-style-filter { filter: contrast(130%) saturate(160%) hue-rotate(-10deg) brightness(105%); }
        .history-sepia { filter: sepia(30%) contrast(110%); }

        /* å¯¶å¯å¤¢å¯¦é«”æ¨£å¼ */
        .poke-sprite-icon { background: transparent; border: none; }
        .poke-sprite-img { width: 100%; height: auto; image-rendering: pixelated; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.4)); }

        @media (max-width: 600px) {
            #pokedex { width: 95vw; height: 95vh; padding: 10px; }
            .custom-layer-control { width: 180px; font-size: 8px; right: 5px; top: 5px; }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="poke-ball-btn"></div>
        <div class="title-box">
            <div style="font-size:20px; color:var(--poke-blue); text-shadow: 2px 2px #ffde00; line-height: 1.5;">å°±æ±ºå®šæ˜¯ä½ äº†ï¼æ”¶æœè‡ºç£æ¶ˆå¤±çš„ç³–å» èˆ‡éµé“<br>Sugar Industry MAP</div>
            <div style="font-size:10px; margin-top:10px; color:#555;">VER 1939.0</div>
        </div>
        <button class="start-btn" onclick="startGame()">PRESS START</button>
    </div>

    <div id="drop-hint"></div>

    <div id="pokedex">
        <div class="header-deco">
            <div class="camera-lens"></div>
            <div class="small-lights"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
        </div>
        <div id="screen-container">
            <div id="map-border"><div id="map"></div></div>
        </div>
        <div id="controls-area">
            <input type="text" id="search-input" placeholder="SEARCH...">
            <div class="btn-group">
                <button onclick="performSearch()">GO!</button>
                <button onclick="map.setView([23.6, 121.0], 7)" style="background:#fff;">RESET</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

    <script>
        function startGame() { document.getElementById('start-screen').classList.add('hidden'); }

        // --- 1. å®šç¾©ç´…çƒå’Œè—çƒçš„ SVG ---
        // é è¨­ç´…çƒ (ç”¨æ–¼å¤§éƒ¨åˆ†é»ä½)
        const iconPokeRedUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="#f00" stroke="#000" stroke-width="2"/><path d="M2 20 H38" stroke="#000" stroke-width="2"/><path d="M2 20 A18 18 0 0 0 38 20 Z" fill="#fff"/><circle cx="20" cy="20" r="5" fill="#fff" stroke="#000" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="#fff" stroke="#000" stroke-width="1"/></svg>`);
        
        // è—çƒ (å°ˆç”¨æ–¼è™å°¾/å–„åŒ–)
        const iconPokeBlueUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="#1976d2" stroke="#000" stroke-width="2"/><path d="M2 20 H38" stroke="#000" stroke-width="2"/><path d="M2 20 A18 18 0 0 0 38 20 Z" fill="#fff"/><circle cx="20" cy="20" r="5" fill="#fff" stroke="#000" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="#fff" stroke="#000" stroke-width="1"/></svg>`);

        // å…¶ä»–åœ–æ¨™ä¿æŒä¸è®Š
        const iconHouseUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M20 5 L5 18 H10 V35 H30 V18 H35 Z" fill="#d32f2f" stroke="#000" stroke-width="2"/><rect x="16" y="22" width="8" height="13" fill="#6d4c41" stroke="#000" stroke-width="2"/></svg>`);
        const defaultImgUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150"><rect width="100%" height="100%" fill="#98cb98"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-size="20" fill="#333">NO DATA</text></svg>`);
        const ballIconSmall = `<svg width="16" height="16" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="18" fill="#f00" stroke="#2a75bb" stroke-width="4"/><path d="M2 20 H38" stroke="#2a75bb" stroke-width="4"/><path d="M2 20 A18 18 0 0 0 38 20 Z" fill="#fff"/><circle cx="20" cy="20" r="6" fill="#fff" stroke="#2a75bb" stroke-width="4"/></svg>`;


        var map = L.map('map', { preferCanvas: true }).setView([23.6, 121.0], 8);
        L.simpleMapScreenshoter({ hidden: false }).addTo(map);

        // --- 2. å¯¶å¯å¤¢å¯¦é«” (æ°¸ä¹…é¡¯ç¤º) ---
        var pokemonOnMapGroup = L.layerGroup(); 

        const pokemonList = [
            // æ°´ç®­é¾œï¼šæ”¾åœ¨æ±éƒ¨å¤–æµ· (å¤ªå¹³æ´‹)
            { name: 'Blastoise', lat: 24.5, lng: 123.0, 
              img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/9.gif', 
              size: 80, dialogue: "å¡å’©! (æˆ‘åœ¨å®ˆè­·æ±æµ·å²¸!)" },
            // å™´ç«é¾ï¼šæ”¾åœ¨è¥¿éƒ¨å¤–æµ· (æµ·å³½ä¸­ç·š)
            { name: 'Charizard', lat: 23.5, lng: 119.2, 
              img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/6.gif', 
              size: 100, dialogue: "å¼å–”! (é€™ç‰‡æµ·å³½é¢¨å¥½å¤§!)" },
            // çš®å¡ä¸˜ï¼šæ”¾åœ¨åŒ—éƒ¨åŸºéš†å¶¼å¤–æµ·
            { name: 'Pikachu', lat: 25.5, lng: 122.0, 
              img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/25.gif', 
              size: 60, dialogue: "çš®å¡çš®å¡! (é€™è£¡é¢¨æ™¯çœŸå¥½!)" }
        ];

        pokemonList.forEach(p => {
            let icon = L.divIcon({
                className: 'poke-sprite-icon',
                html: `<img src="${p.img}" class="poke-sprite-img" style="width:${p.size}px;">`,
                iconSize: [p.size, p.size],
                iconAnchor: [p.size/2, p.size/2],
                popupAnchor: [0, -p.size/2]
            });
            L.marker([p.lat, p.lng], {icon: icon})
             .bindPopup(`<b>${p.name}</b><br>${p.dialogue}`)
             .addTo(pokemonOnMapGroup);
        });

        // --- 3. åœ–å±¤å®šç¾©èˆ‡è¼‰å…¥ ---
        var layerPokemon = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Pokemon Style', maxZoom: 19, className: 'pokemon-style-filter' }).addTo(map);
        var layerModern = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM', maxZoom: 19 });
        var layerHistory1953 = L.tileLayer('https://gis.sinica.edu.tw/tileserver/file-exists.php?img=TM100K_1953-png-{z}-{x}-{y}', { maxZoom: 19, maxNativeZoom: 13, className: 'history-sepia', attribution: 'Sinica 1953', referrerPolicy: 'no-referrer' });
        
        var layer1939 = L.layerGroup(); var layerSugar = L.layerGroup(); var layerExtra = L.layerGroup(); var layerTaiwan = L.layerGroup();
        var searchIndex = [];

        function addToSearchIndex(feature, layer) { if (feature.properties) { let searchText = ""; for (let k in feature.properties) searchText += feature.properties[k] + " "; searchIndex.push({ text: searchText.toLowerCase(), layer: layer, coords: layer.getLatLng ? layer.getLatLng() : layer.getBounds().getCenter() }); }}
        function findImageInProperties(props) { if (!props) return null; if (props.photo) return { url: props.photo, key: 'photo' }; for (let key in props) { let val = String(props[key]); if (val.startsWith('http') || val.match(/\.(jpeg|jpg|gif|png)$/i)) return { url: val, key: key }; } return null; }

        async function loadGeoJSON(fileName, group, color, name) {
            try {
                const res = await fetch(fileName);
                if (!res.ok) throw new Error("404");
                const data = await res.json();
                
                // â˜… 1939 RAILWAY æ¨£å¼å¼·åŒ– â˜…
                let styleOptions = { color: color, weight: 5, opacity: 1, dashArray: null };
                if (name.includes('TAIWAN')) {
                    styleOptions = { color: color, weight: 3, opacity: 1, dashArray: '5,5' };
                } else if (name.includes('1939 RAILWAY')) {
    styleOptions = { color: '#FFFF00', weight: 4, opacity: 1, dashArray: null }; // äº®é»ƒè‰²å¯¦ç·š
}

                L.geoJSON(data, {
                    style: styleOptions,
                    pointToLayer: function(feature, latlng) {
                        let iconUrl = iconPokeRedUrl; // é è¨­ä½¿ç”¨ç´…çƒ
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºéœ€è¦è®Šè‰²çš„è—çƒåœ°é»
                        let match = false;
                        if (feature.properties) {
                            const nameLower = (feature.properties.æ—¥æ²»èˆŠå || feature.properties.æˆ°å¾Œæ–°å || feature.properties.åˆ¥å || '').toLowerCase();
                            if (nameLower.includes('è™å°¾') || nameLower.includes('å–„åŒ–') || nameLower.includes('ç£è£¡') || nameLower.includes('huwei') || nameLower.includes('shanhua')) {
                                match = true;
                            }
                        }

                        // è¨­å®šåœ–æ¨™
                        if (match) {
                            iconUrl = iconPokeBlueUrl; // åŒ¹é…åœ°é»ä½¿ç”¨è—çƒ
                        } else if (name.includes('SUGAR')) {
                            iconUrl = iconHouseUrl; // ç³–æ¥­åœ–å±¤ä½†éè—çƒåœ°é»ï¼Œä½¿ç”¨æˆ¿å±‹åœ–ç¤º
                        } 
                        // å…¶ä»–é»ä½ï¼Œä½¿ç”¨é è¨­ç´…çƒ (iconPokeRedUrl)

                        return L.marker(latlng, {icon: L.icon({ iconUrl: iconUrl, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32], className: 'pixel-marker' })});
                    },
                    onEachFeature: function(feature, layer) {
                        addToSearchIndex(feature, layer);
                        let foundImg = findImageInProperties(feature.properties);
                        let displayImg = foundImg ? foundImg.url : defaultImgUrl;
                        let imgKeyToRemove = foundImg ? foundImg.key : null;
                        
                        // â˜… ä¿®å¾©ï¼šæ–°å¢ onerror å±¬æ€§ä¾†è™•ç†åœ–ç‰‡è¼‰å…¥å¤±æ•— (Pop-up ç ´åœ–å•é¡Œ) â˜…
                        let html = `<img src="${displayImg}" onerror="this.onerror=null;this.src='${defaultImgUrl}'" style="width:100%;height:100px;object-fit:cover;border-bottom:2px solid #000;image-rendering:pixelated;"><div style="padding:10px;font-size:10px;"><b>${name}</b><br>`;
                        if(feature.properties) for(let k in feature.properties) if(k !== imgKeyToRemove && feature.properties[k]) html += `${k}: ${feature.properties[k]}<br>`;
                        html += `</div>`;
                        layer.bindPopup(html);
                    }
                }).addTo(group);
                group.addTo(map);
                updateCustomControl();
            } catch (e) { 
                console.error(`ERROR: ç„¡æ³•è¼‰å…¥ ${fileName}. è«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚`, e);
            }
        }

        // è¼‰å…¥ GeoJSON (å‡è¨­æª”æ¡ˆå­˜åœ¨åŒç›®éŒ„)
        loadGeoJSON('ç³–æ¥­.geojson', layerSugar, '#d32f2f', 'SUGAR FACTORY');
        loadGeoJSON('123456.geojson', layerExtra, '#1976d2', 'HIDDEN DATA');
        loadGeoJSON('å°ç£.geojson', layerTaiwan, '#2e7d32', 'TAIWAN REGION');
               
        

        var layerConfig = [
            { name: "âœ¨ POKEMON STYLE", layer: layerPokemon, type: 'tile' },
            { name: "ğŸ—ºï¸ MODERN MAP (ç¾ä»Š)", layer: layerModern, type: 'tile' },
            { name: "ğŸ“œ 1953 äº¤é€šåœ–", layer: layerHistory1953, type: 'tile' },
             { name: "ğŸ›¤ï¸ Sugar Railway", layer: layerSugar, type: 'vector' },
            { name: "ğŸ¬ Sugar industry", layer: layerExtra, type: 'vector' },
            { name: "ğŸŒ¿ TAIWAN REGION", layer: layerTaiwan, type: 'vector' }
        ];

        const body = document.body;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => body.addEventListener(e, ev => {ev.preventDefault(); ev.stopPropagation();}, false));
        body.addEventListener('dragenter', () => body.classList.add('dragover'));
        body.addEventListener('dragleave', () => body.classList.remove('dragover'));
        body.addEventListener('drop', e => {
            body.classList.remove('dragover');
            [...e.dataTransfer.files].forEach(file => {
                let reader = new FileReader();
                reader.onload = evt => {
                    try {
                        let json = JSON.parse(evt.target.result);
                        let g = L.layerGroup();
                        L.geoJSON(json, {style:{color:'#f0f', weight:5}}).addTo(g);
                        g.addTo(map);
                        layerConfig.push({name: file.name.toUpperCase(), layer: g, type:'vector'});
                        updateCustomControl();
                    } catch(err){}
                };
                reader.readAsText(file);
            });
        });

        function performSearch() { 
            let query = document.getElementById('search-input').value.toLowerCase();
            if (!query) return;
            let result = searchIndex.find(item => item.text.includes(query));
            if (result) { map.flyTo(result.coords, 14, { duration: 1.5 }); result.layer.openPopup(); } 
            else { alert("NOT FOUND!"); }
        }
        document.getElementById('search-input').addEventListener("keypress", function(event) { if (event.key === "Enter") performSearch(); });

        var controlDiv = document.createElement('div');
        controlDiv.className = 'custom-layer-control leaflet-control';
        L.DomEvent.disableClickPropagation(controlDiv); L.DomEvent.disableScrollPropagation(controlDiv);
        document.getElementById('screen-container').appendChild(controlDiv);

        function updateCustomControl() {
            let html = `<div class="control-title-bar">${ballIconSmall} LAYER DEX</div><div class="control-content">`;
            controlDiv.innerHTML = html;
            let contentDiv = controlDiv.querySelector('.control-content');

            layerConfig.forEach(item => {
                let div = document.createElement('div'); div.className = 'layer-item';
                let header = document.createElement('div'); header.className = 'layer-header';
                let label = document.createElement('label'); label.className = 'layer-label';
                let checkbox = document.createElement('input'); checkbox.type = 'checkbox';
                checkbox.checked = map.hasLayer(item.layer);
                
                checkbox.onchange = function() {
                    if (this.checked) {
                        item.layer.addTo(map); slider.disabled = false;
                        if (item.type === 'tile') item.layer.bringToBack();
                        if (item.name.includes("POKEMON") || item.name.includes("MODERN")) item.layer.bringToBack();
                        if (item.type === 'vector') item.layer.eachLayer(l => l.bringToFront());
                        
                        // å¯¶å¯å¤¢å¯¦é«”ä¸å†èˆ‡æ­¤é–‹é—œé€£å‹•
                    } else {
                        map.removeLayer(item.layer); slider.disabled = true;
                        // å¯¶å¯å¤¢å¯¦é«”ä¸å†èˆ‡æ­¤é–‹é—œé€£å‹•
                    }
                };
                
                label.appendChild(checkbox); label.appendChild(document.createTextNode(item.name));
                header.appendChild(label); div.appendChild(header);

                let slider = document.createElement('input'); slider.type = 'range'; slider.min = 0; slider.max = 1; slider.step = 0.1; slider.value = 1;
                slider.className = 'opacity-slider'; slider.disabled = !checkbox.checked;
                slider.oninput = function() {
                    let val = parseFloat(this.value);
                    if (item.type === 'tile') { item.layer.setOpacity(val); }
                    else { item.layer.eachLayer(function(l) { if (l.setStyle) l.setStyle({ opacity: val, fillOpacity: val * 0.5 }); }); }
                };
                div.appendChild(slider); contentDiv.appendChild(div);
            });
        }
        updateCustomControl();
        
        // â˜… ç¢ºä¿å¯¶å¯å¤¢å¯¦é«”åœ–å±¤ä¸€é–‹å§‹å°±å­˜åœ¨ â˜…
        pokemonOnMapGroup.addTo(map);
    </script>
</body>
</html>

