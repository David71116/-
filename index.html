<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°±æ±ºå®šæ˜¯ä½ äº†ï¼æ”¶æœè‡ºç£æ¶ˆå¤±çš„ç³–å» èˆ‡éµé“</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root { --dex-red: #dd0b2d; --screen-bg: #98cb98; --btn-blue: #22edfc; --poke-yellow: #ffcb05; --poke-blue: #2a75bb; }
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Press Start 2P', cursive; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #333; background-image: radial-gradient(#444 15%, transparent 16%), radial-gradient(#444 15%, transparent 16%); background-size: 20px 20px; }
        
        /* å•Ÿå‹•ç•«é¢ */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, var(--dex-red) 50%, #f0f0f0 50%); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.8s ease-in-out; }
        .poke-ball-btn { width: 100px; height: 100px; background: #fff; border: 10px solid #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1; }
        #start-screen.hidden { transform: translateY(-100%); }
        .title-box { background: rgba(255,255,255,0.95); border: 6px solid #000; padding: 30px; text-align: center; margin-bottom: 120px; box-shadow: 10px 10px 0 rgba(0,0,0,0.5); }
        .start-btn { background: #ffde00; border: 4px solid var(--poke-blue); padding: 15px 30px; font-family: 'Press Start 2P', cursive; font-size: 18px; cursor: pointer; box-shadow: 6px 6px 0 #000; animation: blink 1s infinite; margin-top: 100px; }
        @keyframes blink { 50% { opacity: 0; } }

        /* åœ–é‘‘ä»‹é¢ */
        #pokedex { position: relative; z-index: 10; width: 95vw; max-width: 1000px; height: 90vh; max-height: 750px; background-color: var(--dex-red); border-radius: 20px 20px 20px 60px; padding: 20px; display: flex; flex-direction: column; border: 6px solid #000; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        .camera-lens { width: 45px; height: 45px; background: radial-gradient(circle at 30% 30%, #fff, var(--btn-blue)); border: 5px solid #fff; border-radius: 50%; position: absolute; top: 0; left: 0; box-shadow: 0 0 15px var(--btn-blue); animation: lightPulse 3s infinite; }
        @keyframes lightPulse { 0% { opacity: 0.6; } 50% { opacity: 1; box-shadow: 0 0 25px var(--btn-blue); } 100% { opacity: 0.6; } }

        #screen-container { flex-grow: 1; background: #b0b0b0; border-radius: 10px 10px 40px 10px; padding: 15px 15px 40px 15px; border: 4px solid #000; display: flex; flex-direction: column; position: relative; }
        #map-border { border: 4px solid #5a5a5a; border-radius: 5px; height: 100%; background: #000; overflow: hidden; position: relative; }
        #map { width: 100%; height: 100%; background: #a8dcb0; }
        
        #year-display { position: absolute; top: 15px; left: 15px; z-index: 1001; background: rgba(0,0,0,0.85); color: #0f0; padding: 10px 20px; font-family: 'Press Start 2P', cursive; font-size: 20px; border: 3px solid #fff; display: none; text-shadow: 2px 2px #000; pointer-events: none; }

        #controls-area { height: 60px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px 20px; background: #222; border-radius: 10px; border: 3px solid #000; }
        #search-input { width: 100%; background: #98cb98; border: none; padding: 12px; font-family: 'Press Start 2P', cursive; font-size: 10px; color: #000; }
        button { background: #ffde00; border: 3px solid #000; padding: 10px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 9px; box-shadow: 4px 4px 0 #000; }

        @keyframes evolutionFlashAnim { 0% { filter: brightness(100%); } 50% { filter: brightness(800%) contrast(0%); } 100% { filter: brightness(100%); } }
        .evolving-state .poke-sprite-img { animation: evolutionFlashAnim 0.3s infinite linear; }
        .mega-sprite-img { width: 100%; height: auto; image-rendering: pixelated; filter: drop-shadow(0 0 12px var(--btn-blue)) brightness(1.1); animation: megaPowerPulse 1.5s infinite ease-in-out alternate; }
        @keyframes megaPowerPulse { from { transform: scale(1); filter: drop-shadow(0 0 10px var(--btn-blue)); } to { transform: scale(1.1); filter: drop-shadow(0 0 25px var(--btn-blue)); } }

        .poke-sprite-icon { background: transparent !important; border: none !important; overflow: visible !important; }
        .poke-sprite-img { width: 100%; height: auto; image-rendering: pixelated; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.4)); }
        
        .custom-layer-control { position: absolute; top: 15px; right: 10px; z-index: 1000; background: #fff; border: 4px solid var(--poke-blue); border-radius: 15px; font-size: 9px; width: 220px; box-shadow: 6px 6px 0 rgba(0,0,0,0.3); }
        .control-title-bar { background: var(--poke-yellow); border-bottom: 4px solid var(--poke-blue); padding: 8px; text-align: center; font-weight: bold; border-radius: 10px 10px 0 0; }
        .control-content { padding: 10px; max-height: 300px; overflow-y: auto; }
        .layer-item { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .opacity-slider { width: 100%; height: 6px; -webkit-appearance: none; background: #ddd; border-radius: 3px; }
        
        .pokemon-style-filter { filter: contrast(130%) saturate(160%) hue-rotate(-10deg) brightness(105%); }
        .history-sepia { filter: sepia(30%) contrast(110%); }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="poke-ball-btn"></div>
        <div class="title-box">
            <div style="font-size:20px; color:var(--poke-blue); text-shadow: 2px 2px #ffde00;">SUGAR FACTORY<br>MOBILE READY DEX</div>
        </div>
        <button class="start-btn" onclick="startGame()">PRESS START</button>
    </div>

    <div id="yt-bg-player" style="position: absolute; width: 0; height: 0; pointer-events: none;"></div>

    <div id="pokedex">
        <div class="header-deco"><div class="camera-lens"></div></div>
        <div id="screen-container">
            <div id="year-display">YEAR: 1900</div>
            <div id="map-border"><div id="map"></div></div>
        </div>
        <div id="controls-area">
            <input type="text" id="search-input" placeholder="SEARCH...">
            <div style="display:flex; gap:5px;">
                <button onclick="performSearch()">GO!</button>
                <button onclick="resetMap()" style="background:#fff;">RESET</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- 1. èƒŒæ™¯éŸ³æ¨‚èˆ‡éŸ³æ•ˆæ§åˆ¶ (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ) ---
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-bg-player', {
                height: '0', width: '0', videoId: 'sdSwuDDMEzY',
                playerVars: { 'autoplay': 0, 'loop': 1, 'playlist': 'sdSwuDDMEzY' }
            });
        }

        const sndClick = new Audio('https://www.soundjay.com/buttons/button-16.mp3'); 
        const sndEvoProcess = new Audio('https://www.soundjay.com/clocks/sounds/beep-10.mp3'); 
        const sndMegaBurst = new Audio('https://www.soundjay.com/explosion/sounds/explosion-02.mp3'); 

        function playSnd(audio) { audio.currentTime = 0; audio.play().catch(e => console.log("Sound play blocked")); }

        function startGame() { 
            // ç«‹å³æ’­æ”¾é»æ“Šè²
            playSnd(sndClick);

            // [æ ¸å¿ƒ] æ‰‹æ©ŸéŸ³è¨Šè§£é–ï¼šé å…ˆæ’­æ”¾ä¸¦æš«åœæ‰€æœ‰éŸ³æ•ˆæª”
            [sndEvoProcess, sndMegaBurst].forEach(snd => {
                snd.play().then(() => {
                    snd.pause();
                    snd.currentTime = 0;
                }).catch(e => console.log("Unlock blocked"));
            });

            // å•Ÿå‹• YouTube èƒŒæ™¯éŸ³æ¨‚ä¸¦è§£é™¤éœéŸ³
            if (player && player.playVideo) { 
                player.unMute();
                player.setVolume(50);
                player.playVideo(); 
            }

            document.getElementById('start-screen').classList.add('hidden'); 
        }

        // --- 2. åœ°åœ–åˆå§‹åŒ– ---
        var map = L.map('map', { preferCanvas: true, zoomControl: false }).setView([23.6, 121.0], 8);
        map.createPane('pokemonPane').style.zIndex = 650;

        const iconPokeBlueUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="#1976d2" stroke="#000" stroke-width="2"/><path d="M2 20 H38" stroke="#000" stroke-width="2"/><path d="M2 20 A18 18 0 0 0 38 20 Z" fill="#fff"/><circle cx="20" cy="20" r="5" fill="#fff" stroke="#000" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="#fff" stroke="#000" stroke-width="1"/></svg>`);
        const iconPokeRedUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="#f00" stroke="#000" stroke-width="2"/><path d="M2 20 H38" stroke="#000" stroke-width="2"/><path d="M2 20 A18 18 0 0 0 38 20 Z" fill="#fff"/><circle cx="20" cy="20" r="5" fill="#fff" stroke="#000" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="#fff" stroke="#000" stroke-width="1"/></svg>`);
        const defaultImgUrl = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150"><rect width="100%" height="100%" fill="#98cb98"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-size="20" fill="#333">NO DATA</text></svg>`);

        var layerPokemon = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { className: 'pokemon-style-filter' }).addTo(map);
        var layerHistory1953 = L.tileLayer('https://gis.sinica.edu.tw/tileserver/file-exists.php?img=TM100K_1953-png-{z}-{x}-{y}', { className: 'history-sepia' });
        
        var layer1939 = L.layerGroup().addTo(map);
        var layerSugarRail = L.layerGroup().addTo(map);
        var layerExtra = L.layerGroup().addTo(map);
        var pokemonGroup = L.layerGroup().addTo(map);

        let sugarFactories = []; 
        let timelineRunning = false;
        let timelineInterval; 
        let activeMarkers = {}; 

        function bindPopup(f, l) {
            let p = f.properties;
            searchIndex.push({ text: JSON.stringify(p).toLowerCase(), layer: l, coords: l.getLatLng ? l.getLatLng() : l.getBounds().getCenter() });
            let imgHtml = p.url ? `<img src="${p.url}" onerror="this.onerror=null;this.src='${defaultImgUrl}'" style="width:100%;height:90px;object-fit:cover;image-rendering:pixelated;border-bottom:2px solid #000;">` : '';
            l.bindPopup(`${imgHtml}<div style="font-size:9px;padding:8px;line-height:1.4"><b>${p.æ—¥æ²»èˆŠå || 'Unknown'}</b><br>ç¾å: ${p.æˆ°å¾Œæ–°å || 'ç„¡'}<br>ç¶“ç‡Ÿ: ${p.ç¶“ç‡Ÿèµ· || '?'} ~ ${p.ç¶“ç‡Ÿè¨– || '?'}<br>ç”¢èƒ½: ${p['ç”¢èƒ½(å™¸/æ—¥)'] || 'æœªçŸ¥'}</div>`);
        }

        async function loadData(url, group, color, name) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                L.geoJSON(data, {
                    style: { color: color, weight: name.includes('1939') ? 5 : 3, opacity: 0.8 },
                    pointToLayer: (f, ll) => {
                        let isBlue = (f.properties && f.properties.ç¶“ç‡Ÿè¨– >= 2025);
                        if (name.includes('Sugar Railway') || name.includes('Sugar industry')) { sugarFactories.push({ f, ll, isBlue }); }
                        let m = L.marker(ll, { icon: L.icon({ iconUrl: isBlue?iconPokeBlueUrl:iconPokeRedUrl, iconSize: [32, 32], iconAnchor: [16, 32] }) });
                        bindPopup(f, m);
                        return m;
                    }
                }).addTo(group);
                updateControl();
            } catch (e) { console.warn("Load error: " + url); }
        }

        function restoreInitialState() {
            if (timelineInterval) clearInterval(timelineInterval);
            timelineRunning = false;
            layerSugarRail.clearLayers();
            sugarFactories.forEach(item => {
                let m = L.marker(item.ll, { icon: L.icon({ iconUrl: item.isBlue?iconPokeBlueUrl:iconPokeRedUrl, iconSize: [32, 32], iconAnchor: [16, 32] }) }).addTo(layerSugarRail);
                bindPopup(item.f, m);
            });
            document.getElementById('year-display').style.display = 'none';
        }

        function resetMap() {
            playSnd(sndClick);
            map.setView([23.6, 121.0], 8);
            restoreInitialState();
            map.closePopup();
        }

        function runTimeline() {
            if (timelineRunning) return;
            playSnd(sndClick);
            timelineRunning = true;
            layerSugarRail.clearLayers();
            activeMarkers = {}; 
            const yearUI = document.getElementById('year-display');
            yearUI.style.display = 'block';
            let year = 1900;
            
            timelineInterval = setInterval(() => {
                yearUI.innerText = `YEAR: ${year}`;
                sugarFactories.forEach((item, index) => {
                    const startYear = parseInt(item.f.properties.ç¶“ç‡Ÿèµ·);
                    const endYear = parseInt(item.f.properties.ç¶“ç‡Ÿè¨–);
                    if (startYear === year && !activeMarkers[index]) {
                        let m = L.marker(item.ll, { icon: L.icon({ iconUrl: item.isBlue?iconPokeBlueUrl:iconPokeRedUrl, iconSize: [32, 32], iconAnchor: [16, 32] }) }).addTo(layerSugarRail);
                        bindPopup(item.f, m);
                        activeMarkers[index] = m;
                    }
                    if (endYear < year && activeMarkers[index] && endYear < 2025) {
                        layerSugarRail.removeLayer(activeMarkers[index]);
                        delete activeMarkers[index];
                    }
                });
                year++;
                if (year > 2025) {
                    clearInterval(timelineInterval);
                    timelineRunning = false;
                    alert("æ™‚å…‰å½±é›†æ’­æ”¾å®Œç•¢ï¼");
                    restoreInitialState(); 
                }
            }, 60);
        }

        // --- 3. å¯¶å¯å¤¢è§’è‰² ---
        var charizardMarker;
        const pokes = [
            { id: 'charizard', lat: 23.5, lng: 119.5, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/6.gif', size: 100 },
            { id: 'pikachu', lat: 25.5, lng: 121.3, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/25.gif', size: 65 }, 
            { id: 'blastoise', lat: 24.2, lng: 122.5, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/9.gif', size: 85 }
        ];

        pokes.forEach(p => {
            let icon = L.divIcon({ className: 'poke-sprite-icon', html: `<img src="${p.img}" class="poke-sprite-img" style="width:${p.size}px;">`, iconSize: [p.size, p.size], iconAnchor: [p.size/2, p.size/2], popupAnchor: [0, -p.size/2] });
            let m = L.marker([p.lat, p.lng], { icon: icon, pane: 'pokemonPane' }).addTo(pokemonGroup);
            if (p.id === 'charizard') {
                charizardMarker = m;
                m.bindPopup(`<b>å™´ç«é¾æŒ‘æˆ°</b><br>å“ªåº§ç³–å» ç¾åœ¨é‚„æœ‰è£½ç³–ï¼Ÿ<br><div style="margin-top:8px;"><button onclick="checkEvo(true)" style="width:100%;">A. å–„åŒ–ç³–å» </button><button onclick="checkEvo(false)" style="width:100%;margin-top:4px;">B. å°åŒ—ç³–å» </button></div>`);
            } else if (p.id === 'pikachu') {
                m.bindPopup(`<b>çš®å¡ä¸˜å½±é›†</b><br><button onclick="runTimeline()" style="width:100%;margin-top:8px;">æ’­æ”¾æ™‚å…‰å½±é›†</button>`);
            } else { m.bindPopup("<b>æ°´ç®­é¾œ</b><br>å®ˆè­·è‘—æ¶ˆå¤±çš„éµé“è¨˜æ†¶ã€‚"); }
        });

        function checkEvo(correct) {
            playSnd(sndClick);
            if (!correct) { alert("ç­”éŒ¯äº†ï¼"); return; }
            charizardMarker.closePopup();
            playSnd(sndEvoProcess); 
            let el = charizardMarker.getElement();
            if (el) el.classList.add('evolving-state');
            setTimeout(() => {
                playSnd(sndMegaBurst); 
                charizardMarker.setIcon(L.divIcon({ className: 'poke-sprite-icon', html: `<img src="image_0.png" class="mega-sprite-img" style="width:130px;">`, iconSize: [130, 130], iconAnchor: [65, 65], popupAnchor: [0, -65] }));
                if (el) el.classList.remove('evolving-state');
                charizardMarker.setPopupContent("<b>MEGA CHARIZARD X</b><br>ç³–åˆ†åŠ›é‡ 100%ï¼");
                charizardMarker.openPopup();
            }, 1500);
        }

        // --- 4. è¼‰å…¥è³‡æ–™èˆ‡é¢æ¿ ---
        loadData('1939.geojson', layer1939, '#000', 'ğŸš‚ 1939 RAILWAY');
        loadData('ç³–æ¥­.geojson', layerSugarRail, '#d32f2f', 'ğŸ›¤ï¸ Sugar Railway');
        loadData('123456.geojson', layerExtra, '#1976d2', 'ğŸ¬ Sugar industry');

        var layerConfig = [
            { name: "âœ¨ POKEMON STYLE", layer: layerPokemon, type: 'tile' },
            { name: "ğŸ“œ 1953 äº¤é€šåœ–", layer: layerHistory1953, type: 'tile' },
            { name: "ğŸš‚ 1939 RAILWAY", layer: layer1939, type: 'vector' },
            { name: "ğŸ›¤ï¸ Sugar Railway", layer: layerSugarRail, type: 'vector' },
            { name: "ğŸ¬ Sugar industry", layer: layerExtra, type: 'vector' }
        ];

        function updateControl() {
            let html = `<div class="control-title-bar">LAYER DEX</div><div class="control-content">`;
            layerConfig.forEach((item, idx) => {
                html += `<div class="layer-item"><label><input type="checkbox" ${map.hasLayer(item.layer)?'checked':''} onchange="toggleL(${idx}, this.checked)"> ${item.name}</label><br><input type="range" class="opacity-slider" min="0" max="1" step="0.1" value="1" oninput="changeO(${idx}, this.value)"></div>`;
            });
            document.querySelector('.custom-layer-control').innerHTML = html + `</div>`;
        }

        const dexDiv = document.createElement('div');
        dexDiv.className = 'custom-layer-control leaflet-control';
        document.getElementById('screen-container').appendChild(dexDiv);

        window.toggleL = (idx, c) => { 
            playSnd(sndClick);
            const item = layerConfig[idx];
            if (c) { item.layer.addTo(map); if (item.type==='tile') item.layer.bringToBack(); }
            else { map.removeLayer(item.layer); }
        };
        window.changeO = (idx, v) => { 
            let item = layerConfig[idx];
            if (item.type==='tile') item.layer.setOpacity(v);
            else item.layer.eachLayer(l => l.setStyle && l.setStyle({opacity: v, fillOpacity: v*0.5}));
        };

        var searchIndex = [];
        function performSearch() {
            playSnd(sndClick);
            let q = document.getElementById('search-input').value.toLowerCase();
            let res = searchIndex.find(i => i.text.includes(q));
            if (res) { map.flyTo(res.coords, 14); res.layer.openPopup(); }
        }
    </script>
</body>
</html>
